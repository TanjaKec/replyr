<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NA rm • replyr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">replyr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/replyr.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/coalesce.html">coalesce</a>
    </li>
    <li>
      <a href="../articles/DependencySorting.html">Join Dependency Sorting</a>
    </li>
    <li>
      <a href="../articles/joinController.html">Join Controller</a>
    </li>
    <li>
      <a href="../articles/letExample.html">let Example</a>
    </li>
    <li>
      <a href="../articles/NArm.html">NA rm</a>
    </li>
    <li>
      <a href="../articles/ParametricExample.html">Parametric Programming in R</a>
    </li>
    <li>
      <a href="../articles/summary.html">summary</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://www.win-vector.com/">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>NA rm</h1>
                        <h4 class="author">John Mount</h4>
            
            <h4 class="date">2017-11-12</h4>
          </div>

    
    
<div class="contents">
<p>Removing <code>NA</code>s with <code>dplyr</code>.</p>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">'dplyr'</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="kw">library</span>(<span class="st">'replyr'</span>)
<span class="co">#&gt; Loading required package: seplyr</span>
<span class="co">#&gt; Loading required package: wrapr</span>
<span class="co">#&gt; Loading required package: cdata</span>
d &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>),
                <span class="dt">y=</span><span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">5</span>,<span class="ot">NA</span>),
                <span class="dt">z=</span><span class="kw">c</span>(<span class="ot">NA</span>,<span class="st">'a'</span>,<span class="st">'b'</span>),
                <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)
<span class="kw">print</span>(d)
<span class="co">#&gt;   x  y    z</span>
<span class="co">#&gt; 1 1  3 &lt;NA&gt;</span>
<span class="co">#&gt; 2 2  5    a</span>
<span class="co">#&gt; 3 2 NA    b</span>

<span class="cf">if</span> (<span class="kw">requireNamespace</span>(<span class="st">"RSQLite"</span>)) {
  my_db &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/src_dbi.html">src_sqlite</a></span>(<span class="st">":memory:"</span>, <span class="dt">create =</span> <span class="ot">TRUE</span>)
  <span class="co"># my_db &lt;- sparklyr::spark_connect(version='2.0.0', master = "local")</span>
  <span class="kw">class</span>(my_db)
  dRemote &lt;-<span class="st"> </span>replyr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/replyr/topics/replyr_copy_to">replyr_copy_to</a></span>(my_db,d,<span class="st">'d'</span>,<span class="dt">rowNumberColumn=</span><span class="st">'rowNum'</span>)
} <span class="cf">else</span> {
  dRemote &lt;-<span class="st"> </span>d <span class="co"># local stand in when we can't make remote</span>
}
<span class="co">#&gt; Loading required namespace: RSQLite</span>
<span class="kw">print</span>(dRemote)
<span class="co">#&gt; # Source:   table&lt;d&gt; [?? x 4]</span>
<span class="co">#&gt; # Database: sqlite 3.19.3 [:memory:]</span>
<span class="co">#&gt;       x     y     z rowNum</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;int&gt;</span>
<span class="co">#&gt; 1     1     3  &lt;NA&gt;      1</span>
<span class="co">#&gt; 2     2     5     a      2</span>
<span class="co">#&gt; 3     2    NA     b      3</span></code></pre></div>
<p><code>na.omit</code> and <code>complete.cases</code> are the usual ways to detect and eliminate <code>NA</code>s in a local <code>data.frame</code> (Note: we don’t consider removal a correct solution when building predictive models, see please <a href="https://arxiv.org/abs/1611.09477">here</a> for some discussion on other data cleaning strategies.) However, they do not work on remote <code>tbl</code> types:</p>
<div id="complete-cases" class="section level3">
<h3 class="hasAnchor">
<a href="#complete-cases" class="anchor"></a>complete.cases</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">complete.cases</span>(d)
<span class="co">#&gt; [1] FALSE  TRUE FALSE</span>

<span class="kw">complete.cases</span>(dRemote)
<span class="co">#&gt; Error in complete.cases(dRemote): invalid 'type' (list) of argument</span></code></pre></div>
<p>You can’t rely on “stack overflow” solutions that look “dplyr-y” to work on remote data. For example: <a href="http://stackoverflow.com/questions/22353633/filter-for-complete-cases-in-data-frame-using-dplyr-case-wise-deletion" class="uri">http://stackoverflow.com/questions/22353633/filter-for-complete-cases-in-data-frame-using-dplyr-case-wise-deletion</a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="kw">complete.cases</span>(.))
<span class="co">#&gt;   x y z</span>
<span class="co">#&gt; 1 2 5 a</span>

dRemote <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="kw">complete.cases</span>(.))
<span class="co">#&gt; Error in UseMethod("escape"): no applicable method for 'escape' applied to an object of class "c('tbl_dbi', 'tbl_sql', 'tbl_lazy', 'tbl')"</span></code></pre></div>
<p>The solution is to map <code>NA</code> managing functions into the <code>dplyr</code> controlled remote data item.</p>
<p>We would think can compose this use “pure dplyr operations” as follows, but again we end up with differences in local and remote performance.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d<span class="op">$</span>rowNum &lt;-<span class="st"> </span><span class="kw">seq_len</span>(<span class="kw">nrow</span>(d))
d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise_all.html">mutate_all</a></span>(<span class="kw"><a href="http://dplyr.tidyverse.org/reference/funs.html">funs</a></span>(is.na)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">nNAinRow=</span><span class="kw">rowSums</span>(.)<span class="op">-</span>rowNum)
<span class="co">#&gt;       x     y     z rowNum nNAinRow</span>
<span class="co">#&gt; 1 FALSE FALSE  TRUE  FALSE        1</span>
<span class="co">#&gt; 2 FALSE FALSE FALSE  FALSE        0</span>
<span class="co">#&gt; 3 FALSE  TRUE FALSE  FALSE        1</span>

dRemote <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise_all.html">mutate_all</a></span>(<span class="kw"><a href="http://dplyr.tidyverse.org/reference/funs.html">funs</a></span>(is.na)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">nNAinRow=</span><span class="kw">rowSums</span>(.)<span class="op">-</span>rowNum)
<span class="co">#&gt; Error in UseMethod("escape"): no applicable method for 'escape' applied to an object of class "c('tbl_dbi', 'tbl_sql', 'tbl_lazy', 'tbl')"</span></code></pre></div>
<p>What we see is that “what is pure <code>dplyr</code>” depends on what operators are available on the service providing back-end. For example the <code>mutate_if</code> forms (equivilent to <code>SQL</code> <code>UPDATE WHERE</code>) are currently not available for remote sources:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dRemote <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise_all.html">mutate_if</a></span>(<span class="ot">TRUE</span>,is.na) <span class="co"># not correct code, just to trigger "local sources" msg</span>
<span class="co">#&gt; Error: length(.p) == length(vars) is not TRUE</span></code></pre></div>
<p>At some point we admit we are going to have to work over the columns by hand (though we will try to keep them remote).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dRemote <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">nna=</span><span class="dv">0</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">nna=</span>nna<span class="op">+</span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(x),<span class="dv">1</span>,<span class="dv">0</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">nna=</span>nna<span class="op">+</span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(y),<span class="dv">1</span>,<span class="dv">0</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">nna=</span>nna<span class="op">+</span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(z),<span class="dv">1</span>,<span class="dv">0</span>))  
<span class="co">#&gt; # Source:   lazy query [?? x 5]</span>
<span class="co">#&gt; # Database: sqlite 3.19.3 [:memory:]</span>
<span class="co">#&gt;       x     y     z rowNum   nna</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     1     3  &lt;NA&gt;      1     1</span>
<span class="co">#&gt; 2     2     5     a      2     0</span>
<span class="co">#&gt; 3     2    NA     b      3     1</span></code></pre></div>
<p>Because remote data sources may not have the same value coercion rules as <code>R</code> we should get used to being more careful about types (hence the <code>ifelse</code>).</p>
<p>This means we have to parameterize variable names to write code like the following:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cols =<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/setops.html">setdiff</a></span>(<span class="kw">colnames</span>(dRemote),<span class="st">'rowNum'</span>)
dRemote <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">nna=</span><span class="dv">0</span>) -&gt;<span class="st"> </span>dTmp
<span class="cf">for</span>(ci <span class="cf">in</span> cols) {
  dTmp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/se-deprecated.html">mutate_</a></span>(<span class="dt">.dots=</span>stats<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/stats/topics/setNames">setNames</a></span>(<span class="kw">paste0</span>(<span class="st">'nna+ifelse(is.na('</span>,ci,<span class="st">'),1,0)'</span>),<span class="st">'nna'</span>)) -&gt;<span class="st"> </span>
<span class="st">    </span>dTmp
}
<span class="kw">print</span>(dTmp)
<span class="co">#&gt; # Source:   lazy query [?? x 5]</span>
<span class="co">#&gt; # Database: sqlite 3.19.3 [:memory:]</span>
<span class="co">#&gt;       x     y     z rowNum   nna</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     1     3  &lt;NA&gt;      1     1</span>
<span class="co">#&gt; 2     2     5     a      2     0</span>
<span class="co">#&gt; 3     2    NA     b      3     1</span></code></pre></div>
<p>Or using <code><a href="http://www.rdocumentation.org/packages/wrapr/topics/let">wrapr::let</a></code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cols =<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/setops.html">setdiff</a></span>(<span class="kw">colnames</span>(dRemote),<span class="st">'rowNum'</span>)
dRemote <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">nna=</span><span class="dv">0</span>) -&gt;<span class="st"> </span>dTmp
<span class="cf">for</span>(ci <span class="cf">in</span> cols) {
  <span class="kw"><a href="http://www.rdocumentation.org/packages/wrapr/topics/let">let</a></span>(<span class="kw">list</span>(<span class="dt">TARGETCOL=</span>ci),
      dTmp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">nna=</span>nna<span class="op">+</span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(TARGETCOL),<span class="dv">1</span>,<span class="dv">0</span>)) -&gt;<span class="st"> </span>dTmp
  )
}
<span class="kw">print</span>(dTmp)
<span class="co">#&gt; # Source:   lazy query [?? x 5]</span>
<span class="co">#&gt; # Database: sqlite 3.19.3 [:memory:]</span>
<span class="co">#&gt;       x     y     z rowNum   nna</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     1     3  &lt;NA&gt;      1     1</span>
<span class="co">#&gt; 2     2     5     a      2     0</span>
<span class="co">#&gt; 3     2    NA     b      3     1</span></code></pre></div>
<p>What we see is that “what is pure <code>dplyr</code>” depends on what operators are available on the service providing back-end.</p>
</div>
<div id="na-omit" class="section level3">
<h3 class="hasAnchor">
<a href="#na-omit" class="anchor"></a>na.omit</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">na.omit</span>(d)
<span class="co">#&gt;   x y z rowNum</span>
<span class="co">#&gt; 2 2 5 a      2</span>

<span class="kw">na.omit</span>(dRemote)
<span class="co">#&gt; # Source:   table&lt;d&gt; [?? x 4]</span>
<span class="co">#&gt; # Database: sqlite 3.19.3 [:memory:]</span>
<span class="co">#&gt;       x     y     z rowNum</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;int&gt;</span>
<span class="co">#&gt; 1     1     3  &lt;NA&gt;      1</span>
<span class="co">#&gt; 2     2     5     a      2</span>
<span class="co">#&gt; 3     2    NA     b      3</span></code></pre></div>
<p>It is fairly clear how we can build <code>na.omit</code> from <code>complete.cases</code>.</p>
</div>
</div>
<div id="cleanup" class="section level2">
<h2 class="hasAnchor">
<a href="#cleanup" class="anchor"></a>Cleanup</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rm</span>(<span class="dt">list=</span><span class="kw">ls</span>())
<span class="kw">gc</span>()
<span class="co">#&gt;           used (Mb) gc trigger (Mb) max used (Mb)</span>
<span class="co">#&gt; Ncells  675251 36.1    1168576 62.5  1168576 62.5</span>
<span class="co">#&gt; Vcells 1200154  9.2    2060183 15.8  1464428 11.2</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#setup">Setup</a></li>
      <li><a href="#cleanup">Cleanup</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>

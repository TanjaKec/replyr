<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patches to Use dplyr on Remote Data Sources • replyr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Patches to Use dplyr on Remote Data Sources">
<meta property="og:description" content='Patches to use dplyr on remote data sources (SQL databases,
   Spark 2.0.0 and above) in a reliable "generic" fashion (generic meaning
   user code works similarly on all such sources, without needing per-source
   adaption).  Due to the fluctuating nature of dplyr/dbplyr/rlang APIs this package
   is going into maintenance mode.  Most of the replyr functions are now 
   done better by one of the non-monolithic replacement packages: wrapr, seplyr, rquery,
   or cdata.'>
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">replyr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="articles/replyr.html">Get started</a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/DependencySorting.html">Join Dependency Sorting</a>
    </li>
    <li>
      <a href="articles/ParametricExample.html">Parametric Programming in R</a>
    </li>
    <li>
      <a href="articles/coalesce.html">coalesce</a>
    </li>
    <li>
      <a href="articles/joinController.html">Join Controller</a>
    </li>
    <li>
      <a href="articles/letExample.html">let Example</a>
    </li>
    <li>
      <a href="articles/summary.html">summary</a>
    </li>
  </ul>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://www.win-vector.com/">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">

<p><code>replyr</code> is going into maintenance mode. It has been hard (and pointless) to track shifting <code>dplyr</code>/<code>dbplyr</code>/<code>rlang</code> APIs and data structures post <code>dplyr</code> <code>0.5</code>. Most of what it does is now done better in one of our newer non-monolithic packages:</p>
<ul>
<li>Programming and meta-programming tools: <a href="https://CRAN.R-project.org/package=wrapr"><code>wrapr</code></a>.</li>
<li>Big data data manipulation: <a href="https://CRAN.R-project.org/package=rquery"><code>rquery</code></a> and <a href="https://CRAN.R-project.org/package=cdata"><code>cdata</code></a>.</li>
<li>Adapting to standard evaluation interfaces: <a href="https://CRAN.R-project.org/package=seplyr"><code>seplyr</code></a>.</li>
</ul>
<hr>
<p>This document describes <code>replyr</code>, an <a href="https://cran.r-project.org">R</a> package available from <a href="https://github.com/WinVector/replyr">Github</a> and <a href="https://CRAN.R-project.org/package=replyr">CRAN</a>.</p>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>It comes as a bit of a shock for <a href="https://cran.r-project.org">R</a> <a href="https://CRAN.R-project.org/package=dplyr"><code>dplyr</code></a> users when they switch from using a <code>tbl</code> implementation based on R in-memory <code>data.frame</code>s to one based on a remote database or service. A lot of the power and convenience of the <code>dplyr</code> notation is hard to maintain with these more restricted data service providers. Things that work locally can’t always be used remotely at scale. It is emphatically not yet the case that one can practice with <code>dplyr</code> in one modality and hope to move to another back-end without significant debugging and work-arounds. The <a href="https://github.com/WinVector/replyr"><code>replyr</code></a> package attempts to provide practical data manipulation affordances to make code perform similarly on local or remote (big) data.</p>
<p>Note: <code>replyr</code> is meant only for “tame data frames” that is data frames with non-duplicate column names that are also valid <em>simple</em> (without quotes) <code>R</code> variables names and columns that are <code>R</code> simple vector types (numbers, strings, and such).</p>
<p><img src="https://github.com/WinVector/replyr/raw/master/tools/replyrs.png"></p>
<p><code>replyr</code> supplies methods to get a grip on working with remote <code>tbl</code> sources (<code>SQL</code> databases, <code>Spark</code>) through <code>dplyr</code>. The idea is to add convenience functions to make such tasks more like working with an in-memory <code>data.frame</code>. Results still do depend on which <code>dplyr</code> service you use, but with <code>replyr</code> you have fairly uniform access to some useful functions. The rule of thumb is: try <code>dplyr</code> first, and if that does not work check if <code>replyr</code> has researched a work-around.</p>
<p><code>replyr</code> uniformly uses standard or parametric interfaces (names of variables as strings) in favor of name capture so that you can easily program <em>over</em> <code>replyr</code>.</p>
<p>Primary <code>replyr</code> services include:</p>
<ul>
<li><a href="https://winvector.github.io/replyr/articles/joinController.html">Join Controller</a></li>
<li><a href="https://winvector.github.io/replyr/articles/DependencySorting.html">Join Planner</a></li>
<li><a href="https://winvector.github.io/replyr/reference/replyr_split.html"><code>replyr::replyr_split</code></a></li>
<li><a href="https://winvector.github.io/replyr/reference/replyr_bind_rows.html"><code>replyr::replyr_bind_rows</code></a></li>
<li><a href="https://winvector.github.io/replyr/reference/gapply.html"><code>replyr::gapply</code></a></li>
<li><a href="https://winvector.github.io/replyr/reference/replyr_summary.html"><code>replyr::replyr_summary</code></a></li>
<li><a href="https://winvector.github.io/replyr/reference/replyr_apply_f_mapped.html"><code>replyr::replyr_apply_f_mapped</code></a></li>
<li><a href="https://winvector.github.io/wrapr/reference/let.html"><code>wrapr::let</code></a></li>
</ul>
</div>
<div id="wraprlet" class="section level2">
<h2 class="hasAnchor">
<a href="#wraprlet" class="anchor"></a><code>wrapr::let</code>
</h2>
<p><code><a href="https://winvector.github.io/wrapr//reference/let.html">wrapr::let</a></code> allows execution of arbitrary code with substituted variable names (note this is subtly different than binding values for names as with <code><a href="#base/substitute.html">base::substitute</a></code> or <code><a href="#base/with.html">base::with</a></code>). This allows the user to write arbitrary <code>dplyr</code> code in the case of <a href="http://www.win-vector.com/blog/2016/12/parametric-variable-names-and-dplyr/">“parametric variable names”</a> (that is when variable names are not known at coding time, but will become available later at run time as values in other variables) without directly using the <code>dplyr</code> “underbar forms” (and the direct use of <code><a href="#lazyeval/interp.html">lazyeval::interp</a></code>, <code>.dots=stats::setNames</code>, or <code>rlang</code>/<code>tidyeval</code>).</p>
<p>Example:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="#base/library.html">library</a></span>(<span class="st"><a href="https://dplyr.tidyverse.org">'dplyr'</a></span>)</pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="co"># nice parametric function we write</span>
<span class="kw">ComputeRatioOfColumns</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">d</span>,
                                  <span class="kw">NumeratorColumnName</span>,
                                  <span class="kw">DenominatorColumnName</span>,
                                  <span class="kw">ResultColumnName</span>) {
  <span class="kw">wrapr</span>::<span class="fu"><a href="https://winvector.github.io/wrapr//reference/let.html">let</a></span>(
    alias=<span class="fu"><a href="#base/list.html">list</a></span>(NumeratorColumn=<span class="kw">NumeratorColumnName</span>,
               DenominatorColumn=<span class="kw">DenominatorColumnName</span>,
               ResultColumn=<span class="kw">ResultColumnName</span>),
    expr={
      <span class="co"># (pretend) large block of code written with concrete column names.</span>
      <span class="co"># due to the let wrapper in this function it will behave as if it was</span>
      <span class="co"># using the specified paremetric column names.</span>
      <span class="kw">d</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(ResultColumn = <span class="kw">NumeratorColumn</span><span class="op">/</span><span class="kw">DenominatorColumn</span>)
    })
}

<span class="co"># example data</span>
<span class="kw">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="#base/data.frame.html">data.frame</a></span>(a=<span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, b=<span class="fl">3</span><span class="op">:</span><span class="fl">7</span>)

<span class="co"># example application</span>
<span class="kw">d</span> <span class="op">%&gt;%</span> <span class="fu">ComputeRatioOfColumns</span>(<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'c'</span>)
 <span class="co">#    a b         c</span>
 <span class="co">#  1 1 3 0.3333333</span>
 <span class="co">#  2 2 4 0.5000000</span>
 <span class="co">#  3 3 5 0.6000000</span>
 <span class="co">#  4 4 6 0.6666667</span>
 <span class="co">#  5 5 7 0.7142857</span></pre></div>
<p><code><a href="https://winvector.github.io/wrapr//reference/let.html">wrapr::let</a></code> makes construction of abstract functions over <code>dplyr</code> controlled data much easier. It is designed for the case where the “<code>expr</code>” block is large sequence of statements and pipelines.</p>
</div>
<div id="replyrreplyr_apply_f_mapped" class="section level2">
<h2 class="hasAnchor">
<a href="#replyrreplyr_apply_f_mapped" class="anchor"></a><code>replyr::replyr_apply_f_mapped</code>
</h2>
<p><code><a href="https://winvector.github.io/wrapr//reference/let.html">wrapr::let</a></code> was only the secondary proposal in the original <a href="http://www.win-vector.com/blog/2016/12/parametric-variable-names-and-dplyr/">2016 “Parametric variable names” article</a>. What we really wanted was a stack of view so the data pretended to have names that matched the code (i.e., re-mapping the data, not the code).</p>
<p>With a bit of thought we can achieve this if we associate the data re-mapping with a function environment instead of with the data. So a re-mapping is active as long as a given controlling function is in control. In our case that function is <code><a href="reference/replyr_apply_f_mapped.html">replyr::replyr_apply_f_mapped()</a></code> and works as follows:</p>
<p>Suppose the operation we wish to use is a rank-reducing function that has been supplied as function from somewhere else that we do not have control of (such as a package). The function could be simple such as the following, but we are going to assume we want to use it without alteration (including the without the small alteration of introducing <code><a href="https://winvector.github.io/wrapr//reference/let.html">wrapr::let()</a></code>).</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="co"># an external function with hard-coded column names</span>
<span class="kw">DecreaseRankColumnByOne</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">d</span>) {
  <span class="kw">d</span><span class="op">$</span><span class="kw">RankColumn</span> <span class="op">&lt;-</span> <span class="kw">d</span><span class="op">$</span><span class="kw">RankColumn</span> <span class="op">-</span> <span class="fl">1</span>
  <span class="kw">d</span>
}</pre></div>
<p>To apply this function to <code>d</code> (which doesn’t have the expected column names!) we use <code><a href="reference/replyr_apply_f_mapped.html">replyr::replyr_apply_f_mapped()</a></code> to create a new parametrized adapter as follows:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="co"># our data</span>
<span class="kw">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="#base/data.frame.html">data.frame</a></span>(Sepal_Length = <span class="fu"><a href="#base/c.html">c</a></span>(<span class="fl">5.8</span>,<span class="fl">5.7</span>),
                Sepal_Width = <span class="fu"><a href="#base/c.html">c</a></span>(<span class="fl">4.0</span>,<span class="fl">4.4</span>),
                Species = <span class="st">'setosa'</span>,
                rank = <span class="fu"><a href="#base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">2</span>))

<span class="co"># a wrapper to introduce parameters</span>
<span class="kw">DecreaseRankColumnByOneNamed</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">d</span>, <span class="kw">ColName</span>) {
  <span class="kw">replyr</span>::<span class="fu"><a href="reference/replyr_apply_f_mapped.html">replyr_apply_f_mapped</a></span>(<span class="kw">d</span>, 
                                f = <span class="kw">DecreaseRankColumnByOne</span>, 
                                nmap = <span class="fu"><a href="#base/c.html">c</a></span>(RankColumn = <span class="kw">ColName</span>),
                                restrictMapIn = <span class="fl">FALSE</span>, 
                                restrictMapOut = <span class="fl">FALSE</span>)
}

<span class="co"># use</span>
<span class="kw">dF</span> <span class="op">&lt;-</span> <span class="fu">DecreaseRankColumnByOneNamed</span>(<span class="kw">d</span>, <span class="st">'rank'</span>)
<span class="fu"><a href="#base/print.html">print</a></span>(<span class="kw">dF</span>)
 <span class="co">#    Sepal_Length Sepal_Width Species rank</span>
 <span class="co">#  1          5.8         4.0  setosa    0</span>
 <span class="co">#  2          5.7         4.4  setosa    1</span></pre></div>
<p><code><a href="reference/replyr_apply_f_mapped.html">replyr::replyr_apply_f_mapped()</a></code> renames the columns to the names expected by <code>DecreaseRankColumnByOne</code> (the mapping specified in <code>nmap</code>), applies <code>DecreaseRankColumnByOne</code>, and then inverts the mapping before returning the value.</p>
</div>
<div id="replyrreplyr_split" class="section level2">
<h2 class="hasAnchor">
<a href="#replyrreplyr_split" class="anchor"></a><code>replyr::replyr_split</code>
</h2>
<p><code><a href="reference/replyr_split.html">replyr::replyr_split</a></code> and <code><a href="reference/replyr_bind_rows.html">replyr::replyr_bind_rows</a></code> work over many remote data types including <code>Spark</code>. This allows code like the following:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu"><a href="#base/message.html">suppressPackageStartupMessages</a></span>(<span class="fu"><a href="#base/library.html">library</a></span>(<span class="st"><a href="https://dplyr.tidyverse.org">"dplyr"</a></span>))
<span class="fu"><a href="#base/library.html">library</a></span>(<span class="st"><a href="https://github.com/WinVector/replyr/">"replyr"</a></span>)
<span class="kw">sc</span> <span class="op">&lt;-</span> <span class="kw">sparklyr</span>::<span class="fu">spark_connect</span>(version=<span class="st">'2.0.2'</span>, 
                              master = <span class="st">"local"</span>)
                              
<span class="kw">diris</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/copy_to.html">copy_to</a></span>(<span class="kw">sc</span>, <span class="kw">iris</span>, <span class="st">'diris'</span>)

<span class="kw">f2</span> <span class="op">&lt;-</span> <span class="kw">.</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="kw">Sepal_Length</span>, <span class="kw">Sepal_Width</span>, <span class="kw">Petal_Length</span>, <span class="kw">Petal_Width</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="#utils/head.html">head</a></span>(<span class="fl">2</span>)

<span class="kw">diris</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="reference/replyr_split.html">replyr_split</a></span>(<span class="st">'Species'</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="#base/lapply.html">lapply</a></span>(<span class="kw">f2</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="reference/replyr_bind_rows.html">replyr_bind_rows</a></span>()

<span class="co">## Source:   query [6 x 5]</span>
<span class="co">## Database: spark connection master=local[4] app=sparklyr local=TRUE</span>
<span class="co">## </span>
<span class="co">## # A tibble: 6 x 5</span>
<span class="co">##      Species Sepal_Length Sepal_Width Petal_Length Petal_Width</span>
<span class="co">##        &lt;chr&gt;        &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;</span>
<span class="co">## 1 versicolor          5.0         2.0          3.5         1.0</span>
<span class="co">## 2 versicolor          4.9         2.4          3.3         1.0</span>
<span class="co">## 3     setosa          4.3         3.0          1.1         0.1</span>
<span class="co">## 4     setosa          4.4         2.9          1.4         0.2</span>
<span class="co">## 5  virginica          4.9         2.5          4.5         1.7</span>
<span class="co">## 6  virginica          5.6         2.8          4.9         2.0</span>

<span class="kw">sparklyr</span>::<span class="fu">spark_disconnect</span>(<span class="kw">sc</span>)</pre></div>
</div>
<div id="replyrgapply" class="section level2">
<h2 class="hasAnchor">
<a href="#replyrgapply" class="anchor"></a><code>replyr::gapply</code>
</h2>
<p><code><a href="reference/gapply.html">replyr::gapply</a></code> is a “grouped ordered apply” data operation. Many calculations can be written in terms of this primitive, including per-group rank calculation (assuming your data services supports window functions), per-group summaries, and per-group selections. It is meant to be a specialization of <a href="https://www.jstatsoft.org/article/view/v040i01">“The Split-Apply-Combine”</a> strategy with all three steps wrapped into a single operator.</p>
<p>Example:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu"><a href="#base/library.html">library</a></span>(<span class="st"><a href="https://dplyr.tidyverse.org">'dplyr'</a></span>)</pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="kw">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="#base/data.frame.html">data.frame</a></span>(group=<span class="fu"><a href="#base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">2</span>),
                order=<span class="fu"><a href="#base/c.html">c</a></span>(<span class="fl">.1</span>,<span class="fl">.2</span>,<span class="fl">.3</span>,<span class="fl">.4</span>,<span class="fl">.5</span>))
<span class="kw">rank_in_group</span> <span class="op">&lt;-</span> <span class="kw">.</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(constcol=<span class="fl">1</span>) <span class="op">%&gt;%</span>
          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(rank=<span class="fu"><a href="#base/cumsum.html">cumsum</a></span>(<span class="kw">constcol</span>)) <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span><span class="kw">constcol</span>)
<span class="kw">d</span> <span class="op">%&gt;%</span> <span class="kw">replyr</span>::<span class="fu"><a href="reference/gapply.html">gapply</a></span>(<span class="st">'group'</span>, <span class="kw">rank_in_group</span>, ocolumn=<span class="st">'order'</span>, decreasing=<span class="fl">TRUE</span>)
 <span class="co">#    group order rank</span>
 <span class="co">#  1     1   0.2    1</span>
 <span class="co">#  2     1   0.1    2</span>
 <span class="co">#  3     2   0.5    1</span>
 <span class="co">#  4     2   0.4    2</span>
 <span class="co">#  5     2   0.3    3</span></pre></div>
<p>The user supplies a function or pipeline that is meant to be applied per-group and the <code><a href="reference/gapply.html">replyr::gapply</a></code> wrapper orchestrates the calculation. In this example <code>rank_in_group</code> was assumed to know the column names in our data, so we directly used them instead of abstracting through <code><a href="https://winvector.github.io/wrapr//reference/let.html">wrapr::let</a></code>. <code><a href="reference/gapply.html">replyr::gapply</a></code> defaults to using <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">dplyr::group_by</a></code> as its splitting or partitioning control, but can also perform actual splits using ‘split’ (‘base::split’) or ‘extract’ (sequential extraction). Semantics are slightly different between cases given how <code>dplyr</code> treats grouping columns, the issue is illustrated in the difference between the definitions of <code>sumgroupS</code> and <code>sumgroupG</code> in <a href="https://github.com/WinVector/replyr/blob/master/checks/gapply.md">this example</a>).</p>
</div>
<div id="replyrreplyr_" class="section level2">
<h2 class="hasAnchor">
<a href="#replyrreplyr_" class="anchor"></a><code>replyr::replyr_*</code>
</h2>
<p>The <code>replyr::replyr_*</code> functions are all convenience functions supplying common functionality (such as <code><a href="reference/replyr_nrow.html">replyr::replyr_nrow</a></code>) that works across many data services providers. These are prefixed (instead of being <code>S3</code> or <code>S4</code> methods) so they do not interfere with common methods. Many of these functions can expensive (which is why <code>dplyr</code> does not provide them as a default), or are patching around corner cases (which is why these functions appear to duplicate <code>base::</code> and <code>dplyr::</code> capabilities). The issues <code>replyr::replyr_*</code> claim to patch around have all been filed as issues on the appropriate <code>R</code> packages and are documented <a href="https://github.com/WinVector/replyr/tree/master/issues">here</a> (to confirm they are not phantoms).</p>
<p>Example: <code><a href="reference/replyr_summary.html">replyr::replyr_summary</a></code> working on a database service (when <code><a href="#base/summary.html">base::summary</a></code> does not).</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="kw">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="#base/data.frame.html">data.frame</a></span>(x=<span class="fu"><a href="#base/rep.html">rep</a></span>(<span class="fu"><a href="#base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">2</span>), <span class="fl">5</span>),
                y=<span class="fu"><a href="#base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">5</span>,<span class="fl">NA</span>),
                z=<span class="fu"><a href="#base/c.html">c</a></span>(<span class="fl">NA</span>,<span class="st">'a'</span>,<span class="st">'b'</span>),
                stringsAsFactors = <span class="fl">FALSE</span>)
<span class="kw">my_db</span> <span class="op">&lt;-</span> <span class="kw">DBI</span>::<span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span>(<span class="kw">RSQLite</span>::<span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html">SQLite</a></span>(), <span class="st">":memory:"</span>)
<span class="kw">RSQLite</span>::<span class="fu"><a href="https://rsqlite.r-dbi.org/reference/initExtension.html">initExtension</a></span>(<span class="kw">my_db</span>) <span class="co"># filed as dplyr issue https://github.com/tidyverse/dplyr/issues/3150</span>
<span class="kw">dRemote</span> <span class="op">&lt;-</span> <span class="kw">replyr</span>::<span class="fu"><a href="reference/replyr_copy_to.html">replyr_copy_to</a></span>(<span class="kw">my_db</span>,<span class="kw">d</span>,<span class="st">'d'</span>)

<span class="fu"><a href="#base/summary.html">summary</a></span>(<span class="kw">dRemote</span>)
 <span class="co">#      Length Class                Mode</span>
 <span class="co">#  src 2      src_SQLiteConnection list</span>
 <span class="co">#  ops 2      op_base_remote       list</span>
<span class="fu"><a href="https://tibble.tidyverse.org/reference/glimpse.html">glimpse</a></span>(<span class="kw">dRemote</span>)
 <span class="co">#  Observations: ??</span>
 <span class="co">#  Variables: 3</span>
 <span class="co">#  Database: sqlite 3.29.0 [:memory:]</span>
 <span class="co">#  $ x &lt;dbl&gt; 1, 2, 2, 1, 2, 2, 1, 2, 2, 1, 2, 2, 1, 2, 2</span>
 <span class="co">#  $ y &lt;dbl&gt; 3, 5, NA, 3, 5, NA, 3, 5, NA, 3, 5, NA, 3, 5, NA</span>
 <span class="co">#  $ z &lt;chr&gt; NA, "a", "b", NA, "a", "b", NA, "a", "b", NA, "a", "b", NA, "a", "b"</span>

<span class="kw">replyr</span>::<span class="fu"><a href="reference/replyr_summary.html">replyr_summary</a></span>(<span class="kw">dRemote</span>)
 <span class="co">#    column index     class nrows nna nunique min max     mean       sd lexmin lexmax</span>
 <span class="co">#  1      x     1   numeric    15   0      NA   1   2 1.666667 0.487950   &lt;NA&gt;   &lt;NA&gt;</span>
 <span class="co">#  2      y     2   numeric    15   5      NA   3   5 4.000000 1.054093   &lt;NA&gt;   &lt;NA&gt;</span>
 <span class="co">#  3      z     3 character    15   5      NA  NA  NA       NA       NA      a      b</span>
<span class="kw">cdata</span>::<span class="fu"><a href="https://winvector.github.io/cdata//reference/qlook.html">qlook</a></span>(<span class="kw">my_db</span>, <span class="st">'d'</span>)
 <span class="co">#  table `d` SQLiteConnection </span>
 <span class="co">#   nrow: 15 </span>
 <span class="co">#   NOTE: "obs" below is count of sample, not number of rows of data.</span>
 <span class="co">#  'data.frame':   10 obs. of  3 variables:</span>
 <span class="co">#   $ x: num  1 2 2 1 2 2 1 2 2 1</span>
 <span class="co">#   $ y: num  3 5 NA 3 5 NA 3 5 NA 3</span>
 <span class="co">#   $ z: chr  NA "a" "b" NA ...</span></pre></div>
<p>Data types, capabilities, and row-orders all vary a lot as we switch remote data services. But the point of <code>replyr</code> is to provide at least some convenient version of typical functions such as: <code>summary</code>, <code>nrow</code>, unique values, and filter rows by values in a set.</p>
</div>
<div id="replyr-data-services" class="section level2">
<h2 class="hasAnchor">
<a href="#replyr-data-services" class="anchor"></a><code>replyr</code> Data services</h2>
<p>This is a <em>very</em> new package with no guarantees or claims of fitness for purpose. Some implemented operations are going to be slow and expensive (part of why they are not exposed in <code>dplyr</code> itself).</p>
<p>We will probably only ever cover:</p>
<ul>
<li>Native <code>data.frame</code>s (and <code>tbl</code>/<code>tibble</code>)</li>
<li>
<code>sparklyr</code> (<code>Spark</code> 2.0.0 or greater)</li>
<li><code>RPostgreSQL</code></li>
<li><code>SQLite</code></li>
<li>
<code>RMySQL</code> (limited support in some cases)</li>
</ul>
</div>
<div id="additional-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#additional-functions" class="anchor"></a>Additional functions</h2>
<p>Additional <code>replyr</code> functions include:</p>
<ul>
<li><code><a href="reference/replyr_filter.html">replyr::replyr_filter</a></code></li>
<li><code><a href="reference/replyr_inTest.html">replyr::replyr_inTest</a></code></li>
</ul>
<p>These are designed to subset data based on a columns values being in a given set. These allow selection of rows by testing membership in a set (very useful for partitioning data). Example below:</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="fu"><a href="#base/library.html">library</a></span>(<span class="st"><a href="https://dplyr.tidyverse.org">'dplyr'</a></span>)</pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="kw">values</span> <span class="op">&lt;-</span> <span class="fu"><a href="#base/c.html">c</a></span>(<span class="fl">2</span>)
<span class="kw">dRemote</span> <span class="op">%&gt;%</span> <span class="kw">replyr</span>::<span class="fu"><a href="reference/replyr_filter.html">replyr_filter</a></span>(<span class="st">'x'</span>, <span class="kw">values</span>)
 <span class="co">#  # Source:   table&lt;replyr_filter_52388446252917961169_0000000001&gt; [?? x 3]</span>
 <span class="co">#  # Database: sqlite 3.29.0 [:memory:]</span>
 <span class="co">#         x     y z    </span>
 <span class="co">#     &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;</span>
 <span class="co">#   1     2     5 a    </span>
 <span class="co">#   2     2    NA b    </span>
 <span class="co">#   3     2     5 a    </span>
 <span class="co">#   4     2    NA b    </span>
 <span class="co">#   5     2     5 a    </span>
 <span class="co">#   6     2    NA b    </span>
 <span class="co">#   7     2     5 a    </span>
 <span class="co">#   8     2    NA b    </span>
 <span class="co">#   9     2     5 a    </span>
 <span class="co">#  10     2    NA b</span></pre></div>
</div>
<div id="commentary" class="section level2">
<h2 class="hasAnchor">
<a href="#commentary" class="anchor"></a>Commentary</h2>
<p>There are a few goals for <code>replyr</code>:</p>
<ul>
<li>Providing missing convenience functions that work well over all common <code>dplyr</code> service providers. Examples include <code>replyr_summary</code>, <code>replyr_filter</code>, and <code>replyr_nrow</code>.</li>
<li>Providing a basis for “row number free” data analysis. SQL back-ends don’t commonly supply row number indexing (or even deterministic order of rows), so a lot of tasks you could do in memory by adjoining columns have to be done through formal key-based joins.</li>
<li>Providing emulations of functionality missing from non-favored service providers (such as windowing functions, <code>quantile</code>, <code>sample_n</code>, <code>cumsum</code>; missing from <code>SQLite</code> and <code>RMySQL</code>).</li>
<li>Working around corner case issues, and some variations in semantics.</li>
<li>Sheer bull-headedness in emulating operations that don’t quite fit into the pure <code>dplyr</code> formulation.</li>
</ul>
<p>Good code should fill one important gap and work on a variety of <code>dplyr</code> back ends (you can test <code>RMySQL</code>, and <code>RPostgreSQL</code> using docker as mentioned <a href="http://www.win-vector.com/blog/2016/11/mysql-in-a-container/">here</a> and <a href="http://www.win-vector.com/blog/2016/02/databases-in-containers/">here</a>; <code>sparklyr</code> can be tried in local mode as described <a href="http://spark.rstudio.com">here</a>). I am especially interested in clever “you wouldn’t thing this was efficiently possible, but” solutions (which give us an expanded grammar of useful operators), and replacing current hacks with more efficient general solutions. Targets of interest include <code>sample_n</code> (which isn’t currently implemented for <code>tbl_sqlite</code>), <code>cumsum</code>, and <code>quantile</code> (currently we have an expensive implementation of <code>quantile</code> based on binary search: <code><a href="reference/replyr_quantile.html">replyr::replyr_quantile</a></code>).</p>
<p><code>replyr</code> services include:</p>
<ul>
<li>Moving data into or out of the remote data store (including adding optional row numbers), <code>replyr_copy_to</code> and <code>replyr_copy_from</code>.</li>
<li>Basic summary info: <code>replyr_nrow</code>, <code>replyr_dim</code>, and <code>replyr_summary</code>.</li>
<li>Random row sampling (like <code><a href="https://dplyr.tidyverse.org/reference/sample_n.html">dplyr::sample_n</a></code>, but working with more service providers). Some of this functionality is provided by <code>replyr_filter</code> and <code>replyr_inTest</code>.</li>
<li>Emulating <a href="https://www.jstatsoft.org/article/view/v040i01">The Split-Apply-Combine Strategy</a>, which is the purpose <code>gapply</code>, <code>replyr_split</code>, and <code>replyr_bind_rows</code>.</li>
<li>Emulating <code>tidyr</code> gather/spread (or pivoting and anti-pivoting).</li>
<li>Patching around differences in <code>dplyr</code> services providers (and documenting the reasons for the patches).</li>
<li>Making use of “parameterized names” much easier (that is: writing code does not know the name of the column it is expected to work over, but instead takes the column name from a user supplied variable).</li>
</ul>
<p>Additional desired capabilities of interest include:</p>
<ul>
<li>
<code>cumsum</code> or row numbering (interestingly enough if you have row numbering you can implement cumulative sum in log-n rounds using joins to implement pointer chasing/jumping ideas, but that is unlikely to be practical, <code>lag</code> is enough to generate next pointers, which can be boosted to row-numberings).</li>
<li>Inserting random values (or even better random unique values) in a remote column. Most service providers have a pseudo-random source you can use.</li>
</ul>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h2>
<p><code>replyr</code> is package for speeding up reliable data manipulation using <code>dplyr</code> (especially on databases and <code>Spark</code>). It is also a good central place to collect patches and fixes needed to work around corner cases and semantic variations between versions of data sources.</p>
</div>
<div id="clean-up" class="section level2">
<h2 class="hasAnchor">
<a href="#clean-up" class="anchor"></a>Clean up</h2>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu"><a href="#base/rm.html">rm</a></span>(list=<span class="fu"><a href="#base/ls.html">ls</a></span>())
<span class="fu"><a href="#base/gc.html">gc</a></span>()
 <span class="co">#            used (Mb) gc trigger  (Mb) limit (Mb) max used (Mb)</span>
 <span class="co">#  Ncells  917633 49.1    1873358 100.1         NA  1175762 62.8</span>
 <span class="co">#  Vcells 1711206 13.1    8388608  64.0      16384  2295143 17.6</span></pre></div>
</div>
<div id="note" class="section level2">
<h2 class="hasAnchor">
<a href="#note" class="anchor"></a>Note</h2>
<p>Note: <code>replyr</code> is targeted at data with “tame column names” (column names that are valid both in databases, and as <code>R</code> unquoted variable names) and basic types (column values that are simple <code>R</code> types such as <code>character</code>, <code>numeric</code>, <code>logical</code>, and so on).</p>
<p>Also <code>replyr</code> tries to be a “source agnostic” package, meaning it minimizes the number of places it checks for data source and uses specialized code, this can mean some operations are slow. For example <code>replyr</code> does not (yet) use <code>sparklyr::sdf_pivot()</code>.</p>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Download from CRAN at <br><a href="https://cloud.r-project.org/package=replyr">https://​cloud.r-project.org/​package=replyr</a>
</li>
<li>Browse source code at <br><a href="https://github.com/WinVector/replyr/">https://​github.com/​WinVector/​replyr/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/WinVector/replyr/issues">https://​github.com/​WinVector/​replyr/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li>
<a href="https://www.r-project.org/Licenses/GPL-2">GPL-2</a> | <a href="https://www.r-project.org/Licenses/GPL-3">GPL-3</a>
</li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>John Mount <br><small class="roles"> Author, maintainer </small>  </li>
<li>Nina Zumel <br><small class="roles"> Author </small>  </li>
<li><a href="authors.html">All authors...</a></li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
